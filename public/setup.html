<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulse ‚Äî Setup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1117;
      --bg2: #151820;
      --bg3: #1c2030;
      --border: #ffffff10;
      --border-hover: #22d3ee30;
      --cyan: #22d3ee;
      --cyan-dim: #22d3ee15;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --text-muted: #475569;
      --green: #4ade80;
      --red: #f87171;
      --yellow: #fbbf24;
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: var(--bg); }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 32px 16px 64px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 680px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .header-logo { font-size: 32px; margin-bottom: 8px; }
    .header-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.5px;
    }
    .header-sub {
      font-size: 14px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    /* Card */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--border-hover); }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--cyan);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 20px;
    }

    /* Form fields */
    .field { margin-bottom: 16px; }
    .field:last-child { margin-bottom: 0; }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"] {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      padding: 10px 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 0 2px var(--cyan-dim);
    }

    input::placeholder { color: var(--text-muted); }

    .field-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .field-row input { flex: 1; }

    /* Detect button */
    .btn-detect {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-dim);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      padding: 10px 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .btn-detect:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }
    .btn-detect:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 0;
    }
    .toggle-label {
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }
    .toggle-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-track {
      position: absolute;
      inset: 0;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .toggle-track::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: var(--text-muted);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s, background 0.2s;
    }
    .toggle input:checked + .toggle-track {
      background: var(--cyan-dim);
      border-color: var(--cyan);
    }
    .toggle input:checked + .toggle-track::after {
      background: var(--cyan);
      transform: translateX(20px);
    }

    /* Tag list (docker containers, services) */
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      min-height: 32px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text);
    }
    .tag-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      transition: color 0.15s;
    }
    .tag-remove:hover { color: var(--red); }

    .tag-input-row {
      display: flex;
      gap: 8px;
    }
    .tag-input-row input { flex: 1; }

    /* Docker mode radio */
    .radio-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .radio-opt {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
    }
    .radio-opt input { display: none; }
    .radio-opt.selected {
      border-color: var(--cyan);
      color: var(--cyan);
      background: var(--cyan-dim);
    }
    .radio-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .radio-opt.selected .radio-dot::after {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--cyan);
    }

    /* Bot rows */
    .bot-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .bot-row input { flex: 1; }
    .bot-row .profile-input { max-width: 140px; }
    .bot-statedir-row { display: none; margin-bottom: 8px; padding-left: 8px; }
    .bot-statedir-row.visible { display: flex; gap: 8px; align-items: center; }
    .bot-statedir-row input { flex: 1; font-size: 12px; }
    .btn-remove-bot {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px 10px;
      font-size: 14px;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .btn-remove-bot:hover { border-color: var(--red); color: var(--red); }

    .btn-add {
      background: none;
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      padding: 8px 14px;
      width: 100%;
      transition: all 0.2s;
      margin-top: 4px;
    }
    .btn-add:hover { border-color: var(--cyan); color: var(--cyan); }

    /* Collapsible */
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .collapsible-arrow {
      font-size: 12px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .collapsible-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease;
    }
    .collapsible-body.open { max-height: 2000px; }
    .collapsible-divider { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }

    /* Password field */
    .pass-wrap { position: relative; }
    .pass-wrap input { padding-right: 42px; }
    .pass-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0;
      transition: color 0.15s;
    }
    .pass-toggle:hover { color: var(--text); }

    /* Auth fields */
    .auth-fields { margin-top: 16px; }

    /* Alert telegram row */
    .tg-detected {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #22d3ee10;
      border: 1px solid var(--border-hover);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--cyan);
    }
    .tg-detected .tg-override {
      margin-left: auto;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      text-decoration: underline;
    }
    .tg-detected .tg-override:hover { color: var(--text); }

    /* Alert rules */
    .rule-row {
      display: grid;
      grid-template-columns: 150px 80px 80px 1fr 32px;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .rule-row select, .rule-row input {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      padding: 8px 10px;
      outline: none;
      width: 100%;
      transition: border-color 0.2s;
    }
    .rule-row select:focus, .rule-row input:focus { border-color: var(--cyan); }
    .rule-row select option { background: var(--bg3); }
    .btn-remove-rule {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-remove-rule:hover { border-color: var(--red); color: var(--red); }
    .rule-col-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* Test button */
    .btn-test {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      padding: 8px 14px;
      transition: all 0.2s;
      margin-top: 12px;
    }
    .btn-test:hover { border-color: var(--cyan); color: var(--cyan); }
    .test-result { font-size: 12px; margin-top: 6px; }
    .test-result.ok { color: var(--green); }
    .test-result.err { color: var(--red); }

    /* Save button */
    .save-wrap {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .btn-save {
      background: var(--cyan);
      border: none;
      border-radius: var(--radius-sm);
      color: #000;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 700;
      padding: 12px 32px;
      transition: opacity 0.2s;
    }
    .btn-save:hover { opacity: 0.85; }
    .btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-back {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      padding: 12px 20px;
      text-decoration: none;
      transition: border-color 0.2s, color 0.2s;
      display: inline-block;
    }
    .btn-back:hover { border-color: var(--cyan); color: var(--cyan); }

    .save-error {
      font-size: 13px;
      color: var(--red);
      margin-top: 8px;
    }

    /* Helper text */
    .hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Restart overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 17, 23, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      gap: 20px;
      display: none;
    }
    .overlay.show { display: flex; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlay-text { font-size: 16px; color: var(--text-dim); }
    .overlay-sub { font-size: 13px; color: var(--text-muted); }
  </style>
</head>
<body>

<!-- Restart overlay -->
<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <div class="overlay-text">Restarting Pulse...</div>
  <div class="overlay-sub" id="overlay-sub">Saving your configuration</div>
</div>

<div class="container">

  <div class="header">
    <div class="header-logo">ü´Ä</div>
    <div class="header-title" id="page-title">Welcome to Pulse</div>
    <div class="header-sub" id="page-sub">Configure your dashboard to get started</div>
  </div>

  <!-- General -->
  <div class="card">
    <div class="card-title">General</div>

    <div class="field">
      <label for="label">Server Label</label>
      <input type="text" id="label" placeholder="My Server" />
      <div class="hint">Display name shown in the dashboard header</div>
    </div>

    <div class="field">
      <label for="port">Port</label>
      <input type="number" id="port" value="6682" min="1024" max="65535" />
      <div class="hint">Pulse will restart and you'll be redirected if the port changes</div>
    </div>

    <div class="field">
      <label for="weather">Weather City</label>
      <input type="text" id="weather" placeholder="London" />
    </div>
  </div>

  <!-- Network -->
  <div class="card">
    <div class="card-title">Network</div>
    <div class="field">
      <label>Network Interface</label>
      <div class="field-row">
        <input type="text" id="iface" placeholder="eth0" />
        <button class="btn-detect" onclick="detectIface()">üîç Auto-detect</button>
      </div>
      <div class="hint">Used for bandwidth monitoring (up/down speed)</div>
    </div>
  </div>

  <!-- Docker -->
  <div class="card">
    <div class="card-title">Docker Containers</div>

    <div class="radio-group">
      <label class="radio-opt selected" id="docker-auto-opt" onclick="setDockerMode('auto')">
        <input type="radio" name="docker-mode" value="auto" checked />
        <div class="radio-dot"></div>
        Auto-discover all
      </label>
      <label class="radio-opt" id="docker-manual-opt" onclick="setDockerMode('manual')">
        <input type="radio" name="docker-mode" value="manual" />
        <div class="radio-dot"></div>
        Specific containers
      </label>
    </div>

    <div id="docker-manual-section" style="display:none">
      <div class="tag-list" id="docker-tags"></div>
      <div class="tag-input-row">
        <input type="text" id="docker-input" placeholder="container-name" onkeydown="handleDockerKey(event)" />
        <button class="btn-detect" onclick="discoverDocker()">üîç Discover</button>
        <button class="btn-detect" onclick="addDockerTag()">+ Add</button>
      </div>
    </div>
  </div>

  <!-- Systemd -->
  <div class="card">
    <div class="card-title">Systemd Services</div>
    <div class="tag-list" id="service-tags"></div>
    <div class="tag-input-row">
      <input type="text" id="service-input" placeholder="my-service" onkeydown="handleServiceKey(event)" />
      <button class="btn-detect" onclick="discoverServices()">üîç Discover</button>
      <button class="btn-detect" onclick="addServiceTag()">+ Add</button>
    </div>
    <div class="hint" style="margin-top:8px">Systemd user services to monitor (systemctl --user)</div>
  </div>

  <!-- Security -->
  <div class="card">
    <div class="card-title">Security</div>

    <div class="toggle-row">
      <div>
        <div class="toggle-label">Basic Auth</div>
        <div class="toggle-sub">Protect dashboard with username &amp; password</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="auth-enabled" onchange="toggleAuth()" />
        <div class="toggle-track"></div>
      </label>
    </div>

    <div class="auth-fields" id="auth-fields" style="display:none">
      <div class="field" style="margin-top:16px">
        <label for="auth-user">Username</label>
        <input type="text" id="auth-user" placeholder="admin" autocomplete="off" />
      </div>
      <div class="field">
        <label for="auth-pass">Password</label>
        <div class="pass-wrap">
          <input type="password" id="auth-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
          <button class="pass-toggle" onclick="togglePass()" type="button" title="Show/hide">üëÅ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts (collapsible) -->
  <div class="card">
    <div class="collapsible-header" onclick="toggleAlerts()">
      <div class="card-title" style="margin-bottom:0">Alerts <span style="color:var(--text-muted);font-weight:400;font-size:11px;text-transform:none;letter-spacing:0">(optional)</span></div>
      <div class="collapsible-arrow" id="alerts-arrow">‚ñ∂</div>
    </div>
    <div class="collapsible-body" id="alerts-body">
      <div class="collapsible-divider">

        <!-- Telegram row -->
        <div class="field">
          <label>Telegram</label>
          <div id="tg-auto-row" class="tg-detected" style="display:none">
            ‚úÖ Auto-detected from OpenClaw
            <span class="tg-override" onclick="showTgManual()">Override</span>
          </div>
          <div id="tg-manual-row" style="display:none">
            <div class="field">
              <label for="tg-token">Bot Token</label>
              <input type="text" id="tg-token" placeholder="1234567890:ABCDef..." autocomplete="off" />
            </div>
            <div class="field">
              <label for="tg-chat">Chat ID</label>
              <input type="text" id="tg-chat" placeholder="45118778" autocomplete="off" />
            </div>
          </div>
          <div id="tg-loading-row" style="font-size:13px;color:var(--text-muted)">Checking...</div>
          <button class="btn-test" onclick="testAlert()">üîî Send test alert</button>
          <div class="test-result" id="test-result"></div>
        </div>

        <!-- Cooldown -->
        <div class="field">
          <label for="alert-cooldown">Cooldown between alerts (minutes)</label>
          <input type="number" id="alert-cooldown" value="15" min="1" max="1440" style="max-width:120px" />
        </div>

        <!-- Rules -->
        <div class="field">
          <label>Alert Rules</label>
          <div style="display:grid;grid-template-columns:150px 80px 80px 1fr 32px;gap:6px;margin-bottom:6px">
            <div class="rule-col-label">Metric</div>
            <div class="rule-col-label">Threshold</div>
            <div class="rule-col-label">Duration</div>
            <div class="rule-col-label">Name</div>
            <div></div>
          </div>
          <div id="alert-rules"></div>
          <button class="btn-add" onclick="addAlertRule()" style="margin-top:6px">+ Add rule</button>
          <div class="hint" style="margin-top:8px">Duration: seconds the metric must stay above threshold before firing. Leave 0 for immediate.</div>
        </div>

      </div>
    </div>
  </div>

  <!-- Support -->
  <div class="card">
    <div class="card-title">Support Pulse</div>
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:200px">
        <div style="font-size:13px;color:var(--text-dim);line-height:1.6">Pulse is free and open source. If you find it useful, consider supporting development!</div>
      </div>
      <a href="https://buymeacoffee.com/azamatmajidov" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:#ffdd00;color:#000;font-weight:600;padding:10px 20px;border-radius:8px;text-decoration:none;font-size:14px;white-space:nowrap">‚òï Buy me a coffee</a>
    </div>
  </div>

  <!-- Updates -->
  <div class="card">
    <div class="card-title">Updates</div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:200px">
        <div style="font-size:13px;color:var(--text-dim)" id="update-status">Click "Check for Updates" to see if a new version is available.</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px" id="update-version"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-test" onclick="checkUpdate()" id="update-check-btn">Check for Updates</button>
        <button class="btn-test" onclick="applyUpdate()" id="update-apply-btn" style="display:none;background:var(--cyan);color:#000;border-color:var(--cyan);font-weight:600">Update Now</button>
      </div>
    </div>
  </div>

  <!-- Bots (collapsible) -->
  <div class="card">
    <div class="collapsible-header" onclick="toggleBots()">
      <div class="card-title" style="margin-bottom:0">OpenClaw Bots <span style="color:var(--text-muted);font-weight:400;font-size:11px;text-transform:none;letter-spacing:0">(optional)</span></div>
      <div class="collapsible-arrow" id="bots-arrow">‚ñ∂</div>
    </div>
    <div class="collapsible-body" id="bots-body">
      <div class="collapsible-divider">
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Add OpenClaw bot profiles to show their online status on the dashboard.</div>
        <div id="bot-rows"></div>
        <button class="btn-add" onclick="addBotRow()">+ Add Bot</button>
        <div class="hint" style="margin-top:10px">Leave Profile empty for the default OpenClaw profile</div>
      </div>
    </div>
  </div>

  <!-- T92: Budget (collapsible) -->
  <div class="card">
    <div class="collapsible-header" onclick="toggleBudget()">
      <div class="card-title" style="margin-bottom:0">Cost Budget <span style="color:var(--text-muted);font-weight:400;font-size:11px;text-transform:none;letter-spacing:0">(optional)</span></div>
      <div class="collapsible-arrow" id="budget-arrow">‚ñ∂</div>
    </div>
    <div class="collapsible-body" id="budget-body">
      <div class="collapsible-divider">
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Set a monthly token cost budget. You'll get a Telegram alert when the budget is exceeded.</div>
        <div class="form-row">
          <label for="budget-monthly">Monthly budget (USD)</label>
          <input type="number" id="budget-monthly" value="0" min="0" step="1" placeholder="e.g. 50" style="max-width:140px" />
        </div>
        <div class="form-row">
          <label for="budget-warning">Warning threshold (%)</label>
          <input type="number" id="budget-warning" value="80" min="1" max="100" style="max-width:120px" />
        </div>
        <div class="hint">Set budget to 0 to disable budget alerts</div>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="save-wrap">
    <button class="btn-save" id="save-btn" onclick="save()">Save &amp; Restart</button>
    <a class="btn-back" href="/" id="back-btn" style="display:none">‚Üê Back to Dashboard</a>
  </div>
  <div class="save-error" id="save-error"></div>

</div><!-- /container -->

<script>
  const isSettings = window.location.pathname === '/settings';

  // --- Init ---
  window.addEventListener('DOMContentLoaded', async () => {
    if (isSettings) {
      document.getElementById('page-title').textContent = 'Settings';
      document.getElementById('page-sub').textContent = 'Update your Pulse configuration';
      document.getElementById('save-btn').textContent = 'Save & Restart';
      document.getElementById('back-btn').style.display = 'inline-block';

      try {
        const res = await fetch('/api/config');
        const cfg = await res.json();
        prefill(cfg);
      } catch (e) {
        console.error('Failed to load config:', e);
      }
    }
  });

  function prefill(cfg) {
    if (cfg.label) document.getElementById('label').value = cfg.label;
    if (cfg.port) document.getElementById('port').value = cfg.port;
    if (cfg.weatherLocation) document.getElementById('weather').value = cfg.weatherLocation;
    if (cfg.networkIface && cfg.networkIface !== 'auto') document.getElementById('iface').value = cfg.networkIface;

    // Docker
    if (cfg.dockerContainers === 'auto' || !Array.isArray(cfg.dockerContainers)) {
      setDockerMode('auto');
    } else {
      setDockerMode('manual');
      cfg.dockerContainers.forEach(c => addTag('docker-tags', c));
    }

    // Services
    if (Array.isArray(cfg.systemdServices)) {
      cfg.systemdServices.forEach(s => addTag('service-tags', s));
    }

    // Auth
    if (cfg.auth) {
      document.getElementById('auth-enabled').checked = cfg.auth.enabled;
      toggleAuth();
      if (cfg.auth.username) document.getElementById('auth-user').value = cfg.auth.username;
      if (cfg.auth.password) document.getElementById('auth-pass').value = cfg.auth.password;
    }

    // Alerts
    if (cfg.alerts) {
      if (cfg.alerts.cooldownMinutes) document.getElementById('alert-cooldown').value = cfg.alerts.cooldownMinutes;
      if (cfg.alerts.telegram?.botToken) document.getElementById('tg-token').value = cfg.alerts.telegram.botToken;
      if (cfg.alerts.telegram?.chatId) document.getElementById('tg-chat').value = cfg.alerts.telegram.chatId;
      if (Array.isArray(cfg.alerts.rules) && cfg.alerts.rules.length > 0) {
        const body = document.getElementById('alerts-body');
        const arrow = document.getElementById('alerts-arrow');
        body.classList.add('open');
        arrow.textContent = '‚ñº';
        checkTelegramAuto();
        cfg.alerts.rules.forEach(r => addAlertRule(r.metric, r.threshold, r.duration, r.name));
      }
    }

    // Bots
    if (Array.isArray(cfg.bots) && cfg.bots.length > 0) {
      // Open bots section
      const body = document.getElementById('bots-body');
      body.classList.add('open');
      document.getElementById('bots-arrow').textContent = '‚ñº';
      cfg.bots.forEach(b => addBotRow(b.name, b.profile, b.stateDir));
    }

    // Budget
    if (cfg.budget) {
      if (cfg.budget.monthly) document.getElementById('budget-monthly').value = cfg.budget.monthly;
      if (cfg.budget.warning) document.getElementById('budget-warning').value = cfg.budget.warning;
      if (cfg.budget.monthly > 0) {
        document.getElementById('budget-body').classList.add('open');
        document.getElementById('budget-arrow').textContent = '‚ñº';
      }
    }
  }

  // --- Docker mode ---
  let dockerMode = 'auto';

  function setDockerMode(mode) {
    dockerMode = mode;
    document.getElementById('docker-manual-section').style.display = mode === 'manual' ? 'block' : 'none';
    document.getElementById('docker-auto-opt').classList.toggle('selected', mode === 'auto');
    document.getElementById('docker-manual-opt').classList.toggle('selected', mode === 'manual');
  }

  // --- Tags ---
  function addTag(listId, value) {
    value = value.trim();
    if (!value) return;
    // Deduplicate
    const existing = [...document.getElementById(listId).querySelectorAll('.tag')].map(t => t.dataset.val);
    if (existing.includes(value)) return;

    const list = document.getElementById(listId);
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.dataset.val = value;

    const span = document.createElement('span');
    span.textContent = value;

    const btn = document.createElement('button');
    btn.className = 'tag-remove';
    btn.textContent = '√ó';
    btn.onclick = () => tag.remove();

    tag.appendChild(span);
    tag.appendChild(btn);
    list.appendChild(tag);
  }

  function getTags(listId) {
    return [...document.getElementById(listId).querySelectorAll('.tag')].map(t => t.dataset.val);
  }

  function addDockerTag() {
    const input = document.getElementById('docker-input');
    addTag('docker-tags', input.value);
    input.value = '';
  }

  function handleDockerKey(e) {
    if (e.key === 'Enter') { e.preventDefault(); addDockerTag(); }
  }

  function addServiceTag() {
    const input = document.getElementById('service-input');
    addTag('service-tags', input.value);
    input.value = '';
  }

  function handleServiceKey(e) {
    if (e.key === 'Enter') { e.preventDefault(); addServiceTag(); }
  }

  // --- Auto-detect ---
  async function detectIface() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '...';
    try {
      const res = await fetch('/api/detect/iface');
      const data = await res.json();
      document.getElementById('iface').value = data.iface;
    } catch {}
    btn.disabled = false;
    btn.textContent = 'üîç Auto-detect';
  }

  async function discoverDocker() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '...';
    try {
      const res = await fetch('/api/detect/docker');
      const data = await res.json();
      // Switch to manual and populate
      setDockerMode('manual');
      data.containers.forEach(c => addTag('docker-tags', c));
    } catch {}
    btn.disabled = false;
    btn.textContent = 'üîç Discover';
  }

  async function discoverServices() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '...';
    try {
      const res = await fetch('/api/detect/services');
      const data = await res.json();
      data.services.forEach(s => addTag('service-tags', s));
    } catch {}
    btn.disabled = false;
    btn.textContent = 'üîç Discover';
  }

  // --- Auth toggle ---
  function toggleAuth() {
    const enabled = document.getElementById('auth-enabled').checked;
    document.getElementById('auth-fields').style.display = enabled ? 'block' : 'none';
  }

  // --- Password toggle ---
  function togglePass() {
    const input = document.getElementById('auth-pass');
    input.type = input.type === 'password' ? 'text' : 'password';
  }

  // --- Bots ---
  function toggleBots() {
    const body = document.getElementById('bots-body');
    const arrow = document.getElementById('bots-arrow');
    const open = body.classList.toggle('open');
    arrow.textContent = open ? '‚ñº' : '‚ñ∂';
  }

  function addBotRow(name = '', profile = '', stateDir = '') {
    const container = document.getElementById('bot-rows');
    const wrapper = document.createElement('div');
    wrapper.className = 'bot-wrapper';

    const row = document.createElement('div');
    row.className = 'bot-row';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'bot-name-input';
    nameInput.placeholder = 'Bot Name';
    nameInput.value = name;

    const profileInput = document.createElement('input');
    profileInput.type = 'text';
    profileInput.className = 'profile-input';
    profileInput.placeholder = 'profile (optional)';
    profileInput.value = profile || '';

    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn-remove-bot';
    removeBtn.textContent = '√ó';
    removeBtn.onclick = () => wrapper.remove();

    row.appendChild(nameInput);
    row.appendChild(profileInput);
    row.appendChild(removeBtn);

    const sdRow = document.createElement('div');
    sdRow.className = 'bot-statedir-row' + (profile ? ' visible' : '');
    const sdInput = document.createElement('input');
    sdInput.type = 'text';
    sdInput.className = 'statedir-input';
    sdInput.placeholder = 'State directory (optional) e.g. /home/user/.openclaw-profilename';
    sdInput.value = stateDir || '';
    sdRow.appendChild(sdInput);

    profileInput.addEventListener('input', () => {
      sdRow.classList.toggle('visible', !!profileInput.value.trim());
    });

    wrapper.appendChild(row);
    wrapper.appendChild(sdRow);
    container.appendChild(wrapper);
  }

  function getBots() {
    return [...document.querySelectorAll('.bot-wrapper')].map(wrapper => {
      const row = wrapper.querySelector('.bot-row');
      const sd = wrapper.querySelector('.statedir-input');
      const bot = {
        name: row.querySelector('.bot-name-input').value.trim() || 'Bot',
        profile: row.querySelector('.profile-input').value.trim() || null
      };
      const stateDir = sd ? sd.value.trim() : '';
      if (stateDir) bot.stateDir = stateDir;
      return bot;
    }).filter(b => b.name);
  }

  // --- Alerts ---
  function toggleBudget() {
    const body = document.getElementById('budget-body');
    const arrow = document.getElementById('budget-arrow');
    const open = body.classList.toggle('open');
    arrow.textContent = open ? '‚ñº' : '‚ñ∂';
  }

  function toggleAlerts() {
    const body = document.getElementById('alerts-body');
    const arrow = document.getElementById('alerts-arrow');
    const open = body.classList.toggle('open');
    arrow.textContent = open ? '‚ñº' : '‚ñ∂';
    if (open) checkTelegramAuto();
  }

  async function checkTelegramAuto() {
    const loading = document.getElementById('tg-loading-row');
    const autoRow = document.getElementById('tg-auto-row');
    const manualRow = document.getElementById('tg-manual-row');
    loading.style.display = 'block';
    try {
      const res = await fetch('/api/alerts/status');
      const data = await res.json();
      loading.style.display = 'none';
      if (data.telegram?.configured && data.telegram?.source === 'openclaw') {
        autoRow.style.display = 'flex';
        manualRow.style.display = 'none';
      } else {
        autoRow.style.display = 'none';
        manualRow.style.display = 'block';
      }
    } catch {
      loading.style.display = 'none';
      manualRow.style.display = 'block';
    }
  }

  function showTgManual() {
    document.getElementById('tg-auto-row').style.display = 'none';
    document.getElementById('tg-manual-row').style.display = 'block';
  }

  async function testAlert() {
    const resultEl = document.getElementById('test-result');
    resultEl.textContent = 'Sending...';
    resultEl.className = 'test-result';
    try {
      const res = await fetch('/api/alerts/test', { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        resultEl.textContent = `‚úÖ Sent! Check your Telegram (via ${data.source})`;
        resultEl.className = 'test-result ok';
      } else {
        resultEl.textContent = `‚ùå ${data.error}`;
        resultEl.className = 'test-result err';
      }
    } catch (e) {
      resultEl.textContent = `‚ùå Network error`;
      resultEl.className = 'test-result err';
    }
  }

  const METRIC_OPTIONS = [
    { value: 'cpu', label: 'CPU usage', hasThreshold: true, hasName: false },
    { value: 'ram', label: 'RAM usage', hasThreshold: true, hasName: false },
    { value: 'disk', label: 'Disk usage', hasThreshold: true, hasName: false },
    { value: 'service_down', label: 'Service down', hasThreshold: false, hasName: true },
    { value: 'container_down', label: 'Container down', hasThreshold: false, hasName: true },
    { value: 'bot_offline', label: 'Bot offline', hasThreshold: false, hasName: true },
  ];

  function addAlertRule(metric = 'cpu', threshold = 90, duration = 60, name = '') {
    const container = document.getElementById('alert-rules');
    const row = document.createElement('div');
    row.className = 'rule-row';

    // Metric select
    const sel = document.createElement('select');
    METRIC_OPTIONS.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      if (opt.value === metric) o.selected = true;
      sel.appendChild(o);
    });
    sel.onchange = () => updateRuleRow(row, sel.value);

    // Threshold input
    const threshEl = document.createElement('input');
    threshEl.type = 'number';
    threshEl.placeholder = '%';
    threshEl.min = 1; threshEl.max = 100;
    threshEl.value = threshold;

    // Duration input
    const durEl = document.createElement('input');
    durEl.type = 'number';
    durEl.placeholder = 'sec';
    durEl.min = 0;
    durEl.value = duration;

    // Name input
    const nameEl = document.createElement('input');
    nameEl.type = 'text';
    nameEl.placeholder = 'service/bot name';
    nameEl.value = name;

    // Remove btn
    const rmBtn = document.createElement('button');
    rmBtn.className = 'btn-remove-rule';
    rmBtn.textContent = '√ó';
    rmBtn.onclick = () => row.remove();

    row.appendChild(sel);
    row.appendChild(threshEl);
    row.appendChild(durEl);
    row.appendChild(nameEl);
    row.appendChild(rmBtn);
    container.appendChild(row);
    updateRuleRow(row, metric);
  }

  function updateRuleRow(row, metric) {
    const opt = METRIC_OPTIONS.find(o => o.value === metric);
    const cells = row.querySelectorAll('input');
    const threshEl = cells[0]; // threshold
    const durEl = cells[1];    // duration
    const nameEl = cells[2];   // name
    threshEl.style.visibility = opt?.hasThreshold ? 'visible' : 'hidden';
    durEl.style.visibility = opt?.hasThreshold ? 'visible' : 'hidden';
    nameEl.style.visibility = opt?.hasName ? 'visible' : 'hidden';
  }

  function getAlertRules() {
    return [...document.querySelectorAll('#alert-rules .rule-row')].map(row => {
      const sel = row.querySelector('select').value;
      const inputs = row.querySelectorAll('input');
      const opt = METRIC_OPTIONS.find(o => o.value === sel);
      const rule = { metric: sel };
      if (opt?.hasThreshold) {
        rule.threshold = parseInt(inputs[0].value) || 90;
        rule.duration = parseInt(inputs[1].value) || 0;
      }
      if (opt?.hasName) rule.name = inputs[2].value.trim();
      return rule;
    }).filter(r => r.metric);
  }

  // --- License ---
  function toggleLicense() {
    const body = document.getElementById('license-body');
    const arrow = document.getElementById('license-arrow');
    const open = body.classList.toggle('open');
    arrow.textContent = open ? '‚ñº' : '‚ñ∂';
    if (open) fetchLicenseStatus();
  }

  async function fetchLicenseStatus() {
    try {
      const res = await fetch('/api/license/status');
      const data = await res.json();
      const badge = document.getElementById('license-tier-badge');
      const info = document.getElementById('license-info');
      if (data.valid && data.tier === 'pro') {
        badge.textContent = 'Pro';
        badge.style.background = '#4ade8020';
        badge.style.color = '#4ade80';
        info.style.display = 'block';
        document.getElementById('license-email').textContent = data.email || '‚Äî';
        document.getElementById('license-expiry').textContent = data.expiresAt ? new Date(data.expiresAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : '‚Äî';
      } else {
        badge.textContent = 'Free';
        badge.style.background = '#22d3ee15';
        badge.style.color = 'var(--text-muted)';
        info.style.display = 'none';
      }
    } catch {}
  }

  async function activateLicense() {
    const key = document.getElementById('license-key-input').value.trim();
    const resultEl = document.getElementById('license-result');
    if (!key) {
      resultEl.textContent = 'Please enter a license key';
      resultEl.className = 'test-result err';
      return;
    }
    resultEl.textContent = 'Activating...';
    resultEl.className = 'test-result';
    try {
      const res = await fetch('/api/license/activate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key })
      });
      const data = await res.json();
      if (data.ok) {
        resultEl.textContent = '‚úÖ License activated! Tier: ' + data.tier + ', expires ' + new Date(data.expiresAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        resultEl.className = 'test-result ok';
        fetchLicenseStatus();
      } else {
        resultEl.textContent = '‚ùå ' + (data.error || 'Activation failed');
        resultEl.className = 'test-result err';
      }
    } catch (e) {
      resultEl.textContent = '‚ùå Network error';
      resultEl.className = 'test-result err';
    }
  }

  // --- Save ---
  async function save() {
    const btn = document.getElementById('save-btn');
    const errEl = document.getElementById('save-error');
    errEl.textContent = '';

    const port = parseInt(document.getElementById('port').value);
    const weatherLocation = document.getElementById('weather').value.trim();

    if (!port || port < 1024 || port > 65535) {
      errEl.textContent = 'Port must be between 1024 and 65535';
      return;
    }
    if (!weatherLocation) {
      errEl.textContent = 'Weather city is required';
      return;
    }

    const authEnabled = document.getElementById('auth-enabled').checked;
    if (authEnabled) {
      if (!document.getElementById('auth-user').value.trim()) {
        errEl.textContent = 'Username is required when auth is enabled';
        return;
      }
      if (!document.getElementById('auth-pass').value) {
        errEl.textContent = 'Password is required when auth is enabled';
        return;
      }
    }

    const tgToken = document.getElementById('tg-token').value.trim();
    const tgChat = document.getElementById('tg-chat').value.trim();

    const cfg = {
      label: document.getElementById('label').value.trim() || undefined,
      port,
      weatherLocation,
      networkIface: document.getElementById('iface').value.trim() || 'auto',
      dockerContainers: dockerMode === 'auto' ? 'auto' : getTags('docker-tags'),
      systemdServices: getTags('service-tags'),
      auth: {
        enabled: authEnabled,
        username: document.getElementById('auth-user').value.trim(),
        password: document.getElementById('auth-pass').value
      },
      alerts: {
        telegram: { botToken: tgToken, chatId: tgChat },
        cooldownMinutes: parseInt(document.getElementById('alert-cooldown').value) || 15,
        rules: getAlertRules()
      },
      bots: getBots(),
      budget: {
        monthly: parseFloat(document.getElementById('budget-monthly').value) || 0,
        warning: parseInt(document.getElementById('budget-warning').value) || 80
      }
    };

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
      const res = await fetch('/api/setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cfg)
      });
      const data = await res.json();

      if (!data.ok) {
        errEl.textContent = data.error || 'Failed to save';
        btn.disabled = false;
        btn.textContent = isSettings ? 'Save & Restart' : 'Save & Restart';
        return;
      }

      // Show overlay and poll for restart
      const overlay = document.getElementById('overlay');
      const overlaySub = document.getElementById('overlay-sub');
      overlay.classList.add('show');

      const newPort = data.port;
      const currentPort = parseInt(window.location.port) || 80;

      overlaySub.textContent = 'Waiting for Pulse to restart...';

      // Poll health endpoint
      const targetOrigin = newPort !== currentPort
        ? `${window.location.protocol}//${window.location.hostname}:${newPort}`
        : window.location.origin;

      let attempts = 0;
      const poll = setInterval(async () => {
        attempts++;
        try {
          const health = await fetch(`${targetOrigin}/api/health`, { cache: 'no-store' });
          if (health.ok) {
            clearInterval(poll);
            overlaySub.textContent = 'Done! Redirecting...';
            setTimeout(() => { window.location.href = targetOrigin + '/'; }, 500);
          }
        } catch {
          // Still restarting
          if (attempts > 30) {
            clearInterval(poll);
            overlaySub.textContent = `Done. Open: ${targetOrigin}`;
          }
        }
      }, 1000);

    } catch (err) {
      errEl.textContent = 'Network error: ' + err.message;
      btn.disabled = false;
      btn.textContent = 'Save & Restart';
    }
  }

  // --- Updates ---
  async function checkUpdate() {
    var btn = document.getElementById('update-check-btn');
    var status = document.getElementById('update-status');
    var version = document.getElementById('update-version');
    var applyBtn = document.getElementById('update-apply-btn');
    btn.disabled = true;
    btn.textContent = 'Checking‚Ä¶';
    try {
      var res = await fetch('/api/update/check');
      var data = await res.json();
      if (data.error) throw new Error(data.error);
      version.textContent = 'Current: ' + data.current + ' ¬∑ Latest: ' + data.latest;
      if (data.updateAvailable) {
        status.innerHTML = 'üü° <strong>' + data.behind + ' update' + (data.behind > 1 ? 's' : '') + ' available</strong>';
        status.style.color = 'var(--yellow)';
        applyBtn.style.display = 'inline-flex';
      } else {
        status.innerHTML = '‚úÖ You\'re up to date';
        status.style.color = 'var(--green)';
        applyBtn.style.display = 'none';
      }
    } catch (err) {
      status.textContent = '‚ùå Failed: ' + err.message;
      status.style.color = 'var(--red)';
    }
    btn.disabled = false;
    btn.textContent = 'Check for Updates';
  }

  async function applyUpdate() {
    var btn = document.getElementById('update-apply-btn');
    var status = document.getElementById('update-status');
    if (!confirm('This will update Pulse and restart. Continue?')) return;
    btn.disabled = true;
    btn.textContent = 'Updating‚Ä¶';
    try {
      var res = await fetch('/api/update/apply', { method: 'POST' });
      var data = await res.json();
      if (!data.ok) throw new Error(data.error);
      status.innerHTML = '‚úÖ Updated! Restarting‚Ä¶';
      status.style.color = 'var(--green)';
      setTimeout(function() { location.reload(); }, 3000);
    } catch (err) {
      status.textContent = '‚ùå Update failed: ' + err.message;
      status.style.color = 'var(--red)';
      btn.disabled = false;
      btn.textContent = 'Update Now';
    }
  }
</script>
</body>
</html>
